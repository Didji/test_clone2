<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/jsoverson/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>app/javascripts/controllers/reportController.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"></i></a></h2>
      <p class="stat">59.28</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h2>
      <p class="stat">392</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty"></i></a></h2>
      <p class="stat">79.33</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs"></i></a></h2>
      <p class="stat">5.00</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">angular.module(&#039;smartgeomobile&#039;).controller(&#039;reportController&#039;, function ($scope, $routeParams, $window, $rootScope, Smartgeo,  $location, $http, GiReportBuilder, G3ME, i18n, Report){

    &#039;use strict&#039; ;

    $scope.comesFromIntent = $rootScope.map_activity   || $rootScope.report_activity  ;
    $rootScope.site = $rootScope.site || Smartgeo.get_(&#039;sites&#039;)[$routeParams.site];
    $scope.step = &quot;assets&quot;;
    $scope.fromConsult = false;
    GiReportBuilder.buildAllTemplates($scope.site.activities);

    $scope._MAX_MEDIA_PER_REPORT = Smartgeo._MAX_MEDIA_PER_REPORT ;

    $scope.report = Report.new();
    $scope.report.mission = 1*$routeParams.mission ;
    if(!$routeParams.activity &amp;&amp; $routeParams.assets){
        $scope.report.isCall = true  ;
    } else {
        $scope.report.isCall = false ;
    }
    if($routeParams.activity &amp;&amp; $routeParams.assets &amp;&amp; !G3ME.isLatLngString($routeParams.assets)){
        $scope.fromConsult = true;
        $scope.step = &quot;form&quot;;
        $scope.report.activity = $rootScope.site.activities._byId[$routeParams.activity];

        Smartgeo.findAssetsByGuids($rootScope.site, $routeParams.assets.split(&#039;,&#039;), function(assets){
            $scope.report.assets = assets;
            applyDefaultValues();
            if(!$scope.$$phase) {
                $scope.$apply();
            }
        });
    } else if ($routeParams.activity &amp;&amp; $routeParams.assets &amp;&amp; G3ME.isLatLngString($routeParams.assets)){
        $scope.report.activity = $rootScope.site.activities._byId[$routeParams.activity];
        $scope.fromConsult = true;
        $scope.report.latlng = $routeParams.assets ;
        $scope.step = &#039;form&#039;;
    }  else if ($routeParams.activity &amp;&amp; !$routeParams.assets ){
        $scope.report.activity = $rootScope.site.activities._byId[$routeParams.activity];
    } else if($routeParams.assets &amp;&amp; !G3ME.isLatLngString($routeParams.assets)){
        Smartgeo.findAssetsByGuids($rootScope.site, $routeParams.assets.split(&#039;,&#039;), function(assets){
            $scope.report.assets = assets;
            if(!$scope.$$phase) {
                $scope.$apply();
            }
        });
    }

    $scope.activityListChangeHandler = function(){
        if(!$scope.report.assets.length){
            $scope.loadAssets();
        } else {
            $scope.toForm();
        }
    };

    $scope.applyVisibility = function(){
        $scope.reportTemplate = &#039;report-&#039;+$scope.report.activity.id+&#039;.html&#039;;
        for (var i = 0; i &lt; $rootScope.site.activities.length; i++) {
            if($rootScope.site.activities[i].id == $scope.report.activity.id) {
                $scope.report.activity = $rootScope.site.activities[i];
                var act = $scope.report.activity;
                // We have to flag fields which have visibility consequences
                // to enable a correct layout.
                for(var j = 0, numTabs = act.tabs.length, tab ; j &lt; numTabs; j++) {
                    tab = act.tabs[j];
                    for(var k = 0, numFields = tab.fields.length; k &lt; numFields; k++) {
                        tab.fields[k].isconsequence = (tab.fields[k].visible === false);
                    }
                }
                break;
            }
        }
    };

    $scope.bidouille = function(event ){
        document.querySelector(&#039;#mainview&#039;).firstChild.scrollTop=$(event.currentTarget).closest(&#039;label&#039;)[0].offsetTop-7;
        if(window.screen.height &lt;= 640){
            document.querySelector(&#039;.reportForm&#039;).style.paddingBottom =  &quot;280px&quot;;
        }
    };

    $scope.loadAssets = function(){
        Smartgeo.findAssetsByOkey($rootScope.site, $scope.report.activity.okeys[0], function(assets){
            $scope.assets = assets ;
            if(!$scope.$$phase) {
                $scope.$apply();
            }
        });
    };

    if($scope.report.activity){
        $scope.applyVisibility();
        if(!$scope.fromConsult){
            $scope.loadAssets();
        }
    }

    // Used for field validation
    $scope.numberPattern = /^(\d+([.]\d*)?|[.]\d+)$/;

    function fieldById(id) {
        var report = $scope.report,
            act = report.activity,
            i, numTabs, j, numFields,
            tab;

        for(i = 0, numTabs = act.tabs.length; i &lt; numTabs; i++) {
            tab = act.tabs[i];
            for(j = 0, numFields = tab.fields.length; j &lt; numFields; j++) {
                if(tab.fields[j].id == id) {
                    return tab.fields[j];
                }
            }
        }
        return false;
    }

    function applyDefaultValues() {
        var report = $scope.report,
            act = report.activity,
            fields = report.fields,
            assets = report.assets,
            def,
            i, numTabs, j, numFields,
            tab, field,
            date;
        function pad(number) {
            if ( number &lt; 10 ) {
                return &#039;0&#039; + number;
            }
            return number;
        }

        function getList(pkey, okey) {
            var mm = $rootScope.site.metamodel[okey];
            for(var i in mm.tabs) {
                for(var j in mm.tabs[i].fields) {
                    if(mm.tabs[i].fields[j].key == pkey) {
                        return mm.tabs[i].fields[j].options;
                    }
                }
            }
            return false;
        }

        function getValueFromAssets(pkey, okey) {
            var rv = {}, val;
            for(var i = 0, lim = assets.length; i &lt; lim; i++) {
                var a = JSON.parse(assets[i].asset).attributes,
                    list = getList(pkey, okey);

                val = a[pkey];
                if(list &amp;&amp; $rootScope.site.lists[list] &amp;&amp; $rootScope.site.lists[list][val]) {
                    val = $rootScope.site.lists[list][val];
                }

                rv[assets[i].id] = val;
            }
            return rv;
        }

        for(i = 0, numTabs = act.tabs.length; i &lt; numTabs; i++) {
            tab = act.tabs[i];
            for(j = 0, numFields = tab.fields.length; j &lt; numFields; j++) {
                field = tab.fields[j];
                def = field[&#039;default&#039;];
                // Par priorité sur les valeurs par défaut, on applique les valeurs
                // fixées dans le scope par les intents.
                if($scope[&#039;report_fields[&#039;+field.label+&#039;]&#039;]) {
                    def = $scope[&#039;report_fields[&#039;+field.label+&#039;]&#039;];
                }
                if($scope[&#039;report_fields[$&#039;+field.id+&#039;]&#039;]) {
                    def = $scope[&#039;report_fields[$&#039;+field.id+&#039;]&#039;];
                }
                if(!def) {
                    continue;
                }
                if(&#039;string&#039; === typeof def) {
                    if(field.type === &#039;D&#039; &amp;&amp; def === &#039;#TODAY#&#039;) {
                        date = new Date();
                        def = date.getUTCFullYear()
                                + &#039;-&#039; + pad( date.getUTCMonth() + 1 )
                                + &#039;-&#039; + pad( date.getUTCDate() );
                    }
                    fields[field.id] = def;
                    $scope.report.roFields[field.id] = def;
                } else {
                    def = getValueFromAssets(def.pkey, act.okeys[0]);
                    $scope.report.roFields[field.id] = $scope.formatFieldEntry(def);
                    $scope.report.overrides[field.id] = &#039;&#039;;
                    fields[field.id] = def;
                }
            }
        }
    }

    $scope.formatFieldEntry = function(val) {
        if(&#039;string&#039; === typeof val) {
            return val;
        }
        var str = [];
        for(var a in val) {
            if(val[a]) {
                str.push(val[a]);
            }
        }
        return str.join(&#039;, &#039;);
    };

    $scope.applyConsequences = function(srcId) {
        // Search for src field.
        var field = fieldById(srcId),
            targetField, i, lim, act,
            cond;

        if(!field.actions) {
            return false;
        }

        for(i = 0, lim = field.actions.length; i &lt; lim; i++) {
            act = field.actions[i];
            targetField = fieldById(act.target);
            if(!targetField) {
                continue;
            }

            cond = ($scope.report.fields[srcId] == act.condition);
            switch(act.type) {
                case &quot;show&quot;:
                    targetField.visible = cond;

                    // Si targetField est une case à cocher, elle a peut-être
                    // aussi des conséquences. Si une case à cocher devient invisible,
                    // il faut qu&#039;on la décoche et qu&#039;on applique ses conséquences.
                    if(cond === false &amp;&amp; targetField.type === &#039;O&#039;) {
                        $scope.report.fields[act.target] = &#039;N&#039;;
                        $scope.applyConsequences(act.target);
                    }

                    break;
                case &quot;require&quot;:
                    targetField.required = cond;
                    break;
            }
        }
    };

    $scope.toForm = function() {
        $scope.step = &#039;form&#039;;
        $scope.applyVisibility();
        applyDefaultValues();
    };

    $scope.cancel = function() {
        $location.path(&#039;map/&#039;+$rootScope.site.id);
    };

    $scope.sendReport = function (event) {
        $scope.sendingReport = true ;
        var report = angular.copy($scope.report);
        for (var i = 0; i &lt; report.assets.length; i++) {
            if(report.assets[i].id){
                report.assets[i] = report.assets[i].id ;
            }
        }

        for (i = 0; i &lt; report.ged.length; i++) {
            report.ged[i] = {
                    &#039;content&#039;: getBase64Image(report.ged[i].content)
            };
        }

        for(i in report.overrides) {
            if(report.overrides[i]) {
                report.fields[i] = report.overrides[i];
            }
        }

        delete report.overrides;
        delete report.roFields;

        report.activity  = report.activity.id ;
        report.timestamp = new Date().getTime();
        report.mission   = 1*$rootScope.report_mission || report.mission ;

        Report.save(report).then(null, null, function(){
            $scope.sendingReport = false ;
            if(!$scope.comesFromIntent){
                endOfReport();
            }
        });

        if($scope.comesFromIntent){
            endOfReport();
        }
    };

    function endOfReport(){

        if($rootScope.report_url_redirect){
            $rootScope.report_url_redirect = injectCallbackValues($rootScope.report_url_redirect) || $rootScope.report_url_redirect;
            if(window.SmartgeoChromium &amp;&amp; SmartgeoChromium.redirect){
                SmartgeoChromium.redirect(decodeURI($rootScope.report_url_redirect));
            } else {
                window.open($rootScope.report_url_redirect, &quot;_blank&quot;);
            }
        }

        // TODO: Put all intents variables in something like $rootScope.intent.[map|report]_*
        //       It will be easier to reset context ($rootScope.intent=undefined)
        $rootScope.map_target           = undefined ;
        $rootScope.map_marker           = undefined ;
        $rootScope.map_activity         = undefined ;
        $rootScope.report_activity      = undefined ;
        $rootScope.report_mission       = undefined ;
        $rootScope.report_target        = undefined ;
        $rootScope.report_fields        = undefined ;
        $rootScope.report_url_redirect  = undefined ;

        $location.path(&#039;map/&#039;+$rootScope.site.id);
        if(!$scope.$$phase) {
            $scope.$apply();
        }
    }

    function injectCallbackValues(url){
        if(url.indexOf(&#039;[LABEL_INDEXED_FIELDS]&#039;) != -1){
            var injectedValues = &#039;&#039; ;
            for(var field in $scope.report.fields){
                if($scope.report.fields.hasOwnProperty(field)){
                    var val = $scope.report.fields[field];
                    // /!\ UGLY ALERT WORKS WITH ONLY ONE ASSETS
                    if(typeof val === &#039;object&#039; ){
                        for( var j in val){
                            val = val[j];
                            break;
                        }
                    }
                    injectedValues += &#039;fields[&#039;+getLabelWithFieldId(field)+&#039;]=&#039;+val+&#039;&amp;&#039; ;
                }
            }
            injectedValues = injectedValues.slice(0, injectedValues.length-1);
            url = url.replace(&quot;[LABEL_INDEXED_FIELDS]&quot;, injectedValues);
            return url;
        } else if(url.indexOf(&#039;[KEY_INDEXED_FIELDS]&#039;) != -1){
            var injectedValues = &#039;&#039; ;
            for(var field in $scope.report.fields){
                if($scope.report.fields.hasOwnProperty(field)){
                    injectedValues += &#039;fields[&#039;+field+&#039;]=&#039;+$scope.report.fields[field]+&#039;&amp;&#039; ;
                }
            }
            injectedValues = injectedValues.slice(0, injectedValues.length-1);
            url = url.replace(&quot;[KEY_INDEXED_FIELDS]&quot;, injectedValues);
            return url;
        } else {
            return url;
        }
    }

    function getLabelWithFieldId(id){
        var activity = $scope.report.activity;  // UGLY, need to pass activity in parameters and extract this function
                                                // in something like Smartgeo.utils.getLabelWithFieldId()
        for (var i = 0; i &lt; activity.tabs.length; i++) {
            for (var j = 0; j &lt; activity.tabs[i].fields.length; j++) {
                if(activity.tabs[i].fields[j].id == id){
                    return activity.tabs[i].fields[j].label;
                }
            }
        }
    }

    $scope.toggleCollapse = function(event){
        event.preventDefault();
    };

    $scope.removeGed = function($index){
        $scope.report.ged.splice($index, 1);
    };

    function getBase64Image(src) {
        var img = document.createElement(&quot;img&quot;);
        img.src = src ;
        var canvas = document.createElement(&quot;canvas&quot;);
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext(&quot;2d&quot;);
        ctx.drawImage(img, 0, 0);
        var dataURL = canvas.toDataURL(&quot;image/png&quot;);
        return dataURL ;
    };

});</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
