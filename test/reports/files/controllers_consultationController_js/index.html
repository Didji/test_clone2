<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/jsoverson/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>controllers/consultationController.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"></i></a></h2>
      <p class="stat">71.00</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h2>
      <p class="stat">188</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty"></i></a></h2>
      <p class="stat">30.01</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs"></i></a></h2>
      <p class="stat">1.93</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">angular.module(&#039;smartgeomobile&#039;).controller(&#039;consultationController&#039;, function ($scope, $rootScope, $window, $location, Smartgeo, i18n, G3ME) {

    &#039;use strict&#039;;

    $scope.state = &#039;closed&#039;;
    $scope.loading = false;
    console.log(&#039;ici&#039;);
    angular.element($window).bind(&quot;resize&quot;, function (e) {
        console.log($scope.state);
        // if($scope.state === &#039;open&#039;){
        $scope.open();
        $scope.close();
        // }
    });

    var PREOPEN_TIMER;

    $scope.$watch(&#039;loading&#039;, function () {
        var elt = $(&#039;.consultation-content&#039;)[0];
        elt.style.display = &#039;none&#039;;
        elt.offsetHeight = elt.offsetHeight;
        elt.style.display = &#039;block&#039;;
    });

    // Lorsque la carte nous informe qu&#039;une consultation est demandée,
    // on prépare une ouverture du panneau de consultation. S&#039;il n&#039;y a
    // pas de résultat, on annulera cette ouverture.
    $scope.$on(&quot;CONSULTATION_CLICK_REQUESTED&quot;, function (e, coordinates) {
        $scope.coordinates = coordinates;
        if (PREOPEN_TIMER) {
            clearTimeout(PREOPEN_TIMER);
        }
        PREOPEN_TIMER = setTimeout(function () {
            $scope.loading = true;
            $scope.open();
            $scope.$apply();
        }, 200);
    });
    $scope.$on(&quot;CONSULTATION_CLICK_CANCELED&quot;, function () {
        if (PREOPEN_TIMER) {
            clearTimeout(PREOPEN_TIMER);
        }
        $scope.close();
        $scope.loading = false;
        $scope.$apply();
    });

    $scope.$on(&quot;CONSULTATION_OPEN_PANEL&quot;, function () {
        $scope.open();
        $scope.$apply();
    });

    $scope.$on(&quot;CONSULTATION_CLOSE_PANEL&quot;, function () {
        $scope.close();
    });

    $scope.$on(&quot;UPDATE_CONSULTATION_ASSETS_LIST&quot;, function (event, assets) {

        if (PREOPEN_TIMER) {
            clearTimeout(PREOPEN_TIMER);
        }

        $scope.groups = {};
        $scope.assets = assets;
        $scope.assets._byGuid = [];
        for (var i = 0; i &lt; assets.length; i++) {
            if (!$scope.groups[assets[i].priority]) {
                $scope.groups[assets[i].priority] = {};
            }
            if (!$scope.groups[assets[i].priority][assets[i].okey]) {
                $scope.groups[assets[i].priority][assets[i].okey] = {};
            }
            $scope.assets._byGuid[assets[i].guid] = assets[i];
            $scope.groups[assets[i].priority][assets[i].okey][assets[i].guid] = assets[i];
        }
        $scope.open();
        $scope.loading = false;
        $scope.$apply();

        $rootScope.$broadcast(&quot;UNHIGHLIGHT_ALL_ASSET&quot;);

        $(&quot;.collapse&quot;).collapse({
            toggle: false
        });

        // $(document).on(&#039;show.bs.collapse&#039;, &quot;.collapse&quot;, function(){
        //     $rootScope.$broadcast(&quot;HIGHLIGHT_ASSET&quot;, $scope.assets._byGuid[this.id.match(/collapse-(.*)/)[1]]);
        // }).on(&#039;hide.bs.collapse&#039;, &quot;.collapse&quot;, function(){
        //     console.log(&#039;icii&#039;, $scope.assets._byGuid[this.id.match(/collapse-(.*)/)[1]]);
        //     $rootScope.$broadcast(&quot;UNHIGHLIGHT_ASSET&quot;, $scope.assets._byGuid[this.id.match(/collapse-(.*)/)[1]]);
        // });
    });

    $scope.gotoAsset = function (asset) {

        //   /!\ REFACTOR ALERT /!\
        // TODO : make polyfill class

        var coords = asset.geometry.type === &quot;Point&quot; ? {
            x: asset.geometry.coordinates[0],
            y: asset.geometry.coordinates[1]
        } : {
            x: asset.geometry.coordinates[0][0],
            y: asset.geometry.coordinates[0][1]
        };

        if (window.SmartgeoChromium &amp;&amp; SmartgeoChromium.goTo &amp;&amp; SmartgeoChromium.locate) {

            ChromiumCallbacks[0] = function (lng, lat, alt) {
                SmartgeoChromium.goTo(lng, lat, coords.x, coords.y);
            };

            ChromiumCallbacks[2] = function () {
                alertify.error(i18n.get(&quot;_CONSULTATION_GPS_FAIL&quot;));
            };

            SmartgeoChromium.locate();

        } else {
            Smartgeo.getUsersLocation(function (fromLat, fromLng) {
                if (!navigator.userAgent.match(/Android/i) &amp;&amp; !navigator.userAgent.match(/iPhone/i) &amp;&amp; !navigator.userAgent.match(/iPad/i)) {
                    window.open(&quot;http://maps.apple.com/?saddr=&quot; + fromLat + &quot;,&quot; + fromLng + &quot;&amp;daddr=&quot; + coords.y + &quot;,&quot; + coords.x);
                } else {
                    cordova.exec(null, function () {
                        alertify.error(i18n.get(&quot;_CONSULTATION_GPS_FAIL&quot;));
                    }, &quot;gotoPlugin&quot;, &quot;goto&quot;, [fromLat, fromLng, coords.y, coords.x]);
                }
            }, function () {
                alertify.error(i18n.get(&quot;_CONSULTATION_GPS_FAIL&quot;));
            });
        }

    };

    $scope.openLocatedReport = function (lat, lng) {
        $location.path(&#039;report/&#039; + $rootScope.site.id + &#039;/&#039; + $rootScope.report_activity + &#039;/&#039; + lat + &#039;,&#039; + lng + &#039;/&#039;);
    };

    $scope.zoomOnAsset = function (asset) {
        $rootScope.$broadcast(&quot;ZOOM_ON_ASSET&quot;, asset);

        if (Smartgeo.isRunningOnLittleScreen()) {
            $scope.close();
        }
    };

    $scope.toggleConsultationPanel = function () {
        $scope[($scope.state === &#039;open&#039; ? &#039;close&#039; : &#039;open&#039;)]();
    };

    $scope.toggleAsset = function (asset) {
        asset.open = !asset.open;
        $rootScope.$broadcast((asset.open ? &quot;&quot; : &quot;UN&quot;) + &quot;HIGHLIGHT_ASSET&quot;, asset);
    };

    $scope.close = function () {
        if ($scope.state === &#039;closed&#039;) {
            return;
        }
        G3ME.fullscreen();
        $scope.state = &#039;closed&#039;;
        $(&quot;.consultation-panel&quot;).first().removeClass(&#039;open&#039;).css(&#039;width&#039;, 0);
    };

    $scope.open = function () {
        if ($scope.state === &#039;open&#039;) {
            return;
        }
        G3ME.reduceMapWidth(Smartgeo._SIDE_MENU_WIDTH);
        if (Smartgeo.isRunningOnLittleScreen()) {
            $rootScope.$broadcast(&#039;_MENU_CLOSE_&#039;);
        }
        $scope.state = &#039;open&#039;;
        $(&quot;.consultation-panel&quot;).first().addClass(&#039;open&#039;).css(&#039;width&#039;, Smartgeo._SIDE_MENU_WIDTH);
    };

    $scope.definedFilter = function (value) {
        return true;
    };

    $scope.addAssetsToMission = function (asset, mission, $event) {
        if ($event) {
            $event.preventDefault();
        }
        $rootScope.addAssetToMission(asset, mission);
    };

});</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
