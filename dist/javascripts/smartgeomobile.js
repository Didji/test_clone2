var smartgeomobile=angular.module("smartgeomobile",["ngRoute","ui.bootstrap","ui.select2"]).config(["$routeProvider",function(a,d){a.when("/",{templateUrl:"partials/login.html"}).when("/sites/",{templateUrl:"partials/sites.html"}).when("/report/:site",{templateUrl:"partials/report.html"}).when("/report/:site/:activity",{templateUrl:"partials/report.html"}).when("/report/:site/:activity/:assets",{templateUrl:"partials/report.html"}).when("/sites/install/:site",{templateUrl:"partials/installation.html"}).when("/sites/uninstall/:site",
{templateUrl:"partials/uninstall.html"}).when("/sites/update/:site",{templateUrl:"partials/update.html"}).when("/map/:site",{templateUrl:"partials/map.html"}).when("/intent/:controller/?:args",{template:" ",controller:"intentController"}).otherwise({template:" ",controller:function(a){console.log(a.url());a.path("/")}})}]).config(["$httpProvider",function(a){a.defaults.withCredentials=!0;a.defaults.useXDomain=!0;a.defaults.cache=!1}]).directive("camera",function(){return{restrict:"A",require:"ngModel",
link:function(a,d,m,b){d.on("click",function(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(navigator.getMedia){var d=!1,c=document.createElement("video");canvas=document.createElement("canvas");width=320;height=0;navigator.getMedia({video:!0,audio:!1},function(a){navigator.mozGetUserMedia?c.mozSrcObject=a:c.src=(window.URL||window.webkitURL).createObjectURL(a);c.play()},function(a){console.log("An error occured! "+
a)});c.addEventListener("canplay",function(l){d||(height=c.videoHeight/(c.videoWidth/width),c.setAttribute("width",width),c.setAttribute("height",height),canvas.setAttribute("width",width),canvas.setAttribute("height",height),d=!0);canvas.width=width;canvas.height=height;canvas.getContext("2d").drawImage(c,0,0,width,height);a.$apply(function(){b.$viewValue=b.$viewValue||[];b.$viewValue.push({content:canvas.toDataURL("image/png")})})},!1)}else if(navigator.camera)navigator.camera.getPicture(function(l){a.$apply(function(){b.$viewValue=
b.$viewValue||[];b.$viewValue.push({content:l})})},function(a){b.$setValidity("error",!1)},{quality:50,quality:100,sourceType:navigator.camera.PictureSourceType.CAMERA,mediaType:navigator.camera.MediaType.PICTURE,destinationType:Camera.DestinationType.FILE_URI,correctOrientation:!1,saveToPhotoAlbum:!0});else{var l=document.createElement("img");l.src="http://placehold.it/350x150";l.onload=function(){var c=document.createElement("canvas");c.width=l.width;c.height=l.height;c.getContext("2d").drawImage(l,
0,0);a.$apply(function(){b.$viewValue=b.$viewValue||[];b.$viewValue.push({content:c.toDataURL("image/png")})})}}})}}});
angular.module("smartgeomobile").factory("G3ME",["SQLite","Smartgeo","$rootScope",function(a,d,m){var b={active_layers:!1,assetsMarkers:[],mapDiv:null,mapDivId:null,benchMe:!1,benchmarks:{},benchmarkResults:[],benchmarkGlobalResultPerSQL:0,benchmarkGlobalResultPerTile:0,benchmarkElapsedBenchmarks:0,benchmarksLimit:10,benchmarkGeneralStatistics:[],filecacheIsEnable:!0,initialize:function(a,c,l,e){this.site=c;this.tileUrl=this.site.EXTERNAL_TILEURL;this.mapDiv=document.getElementById(a);this.map=(new L.map(this.mapDiv,
{attributionControl:!1,zoomControl:!1,maxZoom:d.MAX_ZOOM,minZoom:d.MIN_ZOOM})).addControl(L.control.zoom({position:"topright"}));l&&l.length&&!b.benchMe||(l=[[this.site.extent.ymin,this.site.extent.xmin],[this.site.extent.ymax,this.site.extent.xmax]]);l[0]instanceof Array||b.benchMe?b.map.fitBounds(l):isNaN(l[0])||(b.map.setView(l,18),e&&(e._map&&e._map.removeLayer(e),e.addTo(b.map)));b.invalidateMapSize();this.tileUrl||(this.tileUrl=d.get("url").replace(/index.php.+$/,""),this.tileUrl+="getTuileTMS.php?z={z}&x={x}&y={y}");
backgroundTile=this.filecacheIsEnable?L.TileLayer.FileCache:L.TileLayer;this.backgroundTile=(new backgroundTile(this.tileUrl,{maxZoom:d.MAX_ZOOM,minZoom:d.MIN_ZOOM})).addTo(this.map);this.canvasTile=(new L.TileLayer.Canvas({maxZoom:d.MAX_ZOOM,minZoom:d.MIN_ZOOM})).addTo(this.map);this.canvasTile.drawTile=function(a,c){b.drawTile(a,c,b.benchMe)};for(var g in this.site.symbology)this.site.symbology[g]&&this.site.symbology[g].style&&(a=new Image,a.src=this.site.symbology[g].style.symbol.icon,this.site.symbology[g].style.image=
a);this.canvasTile.redraw();$(window).on("resize",function(){b.tilesOnScreen=~~(window.innerHeight/256*(window.innerWidth/256))+1});b.tilesOnScreen=~~(window.innerHeight/256*(window.innerWidth/256))+1},parseTarget:function(a,c,l){b.isLatLngString(c)?l(c.split(",")):d.findAssetsByGuids(a,c,function(a){a.length?1===a.length&&l([a[0].ymin,a[0].xmin]):l([])})},isLatLngString:function(a){return null!==(a||"").match(/^-?\d+[.]\d*,-?\d+[.]\d*$/)},invalidateMapSize:function(a,c){setTimeout(function(){b.map.invalidateSize();
c&&c()},10)},extents_match:function(a,c){return a.xmax>c.xmin&&c.xmax>a.xmin&&a.ymax>c.ymin&&c.ymax>a.ymin},setVisibility:function(a){this.active_layers=[];for(var c in a)a[c].status&&this.active_layers.push(c);this.canvasTile.redraw()},getVisibility:function(){if(!1===this.active_layers)return!1;var a={},c;for(c in this.active_layers)a[this.active_layers[c]]=!0;return a},benchStart:function(a){b.benchmarks[a]=(new Date).getTime()},benchStop:function(a){a=(new Date).getTime()-b.benchmarks[a];b.benchmarkResults.push(a);
var c=b.benchmarkResults.length;setTimeout(function(){c===b.benchmarkResults.length&&b.benchProcessResults()},500)},benchProcessResults:function(){for(var a=0,c=0;c<b.benchmarkResults.length;c++)a+=b.benchmarkResults[c];b.benchmarkGeneralStatistics.push({tile:a/b.tilesOnScreen,request:a/b.benchmarkResults.length});b.benchmarkGlobalResultPerSQL+=a/b.tilesOnScreen;b.benchmarkGlobalResultPerTile+=a/b.benchmarkResults.length;b.benchmarkResults=[];b.benchmarks={};b.benchmarkElapsedBenchmarks++;b.benchmarkElapsedBenchmarks<
b.benchmarksLimit?this.canvasTile.redraw():(b.benchmarkGeneralStatistics.benchmarkGlobalResultPerSQL=b.benchmarkGlobalResultPerSQL/b.benchmarksLimit,b.benchmarkGeneralStatistics.benchmarkGlobalResultPerTile=b.benchmarkGlobalResultPerTile/b.benchmarksLimit,console.log(b.benchmarkGeneralStatistics),b.benchmarkElapsedBenchmarks=0)},drawTile:function(d,c,l){var e=d.getContext("2d"),g=this.map.getZoom(),h=L.CRS.EPSG4326;c=c.multiplyBy(256);var p=c.add(new L.Point(256,256));c=h.project(this.map.unproject(c,
g));var p=h.project(this.map.unproject(p,g)),n=this.map.latLngToLayerPoint({lat:c.y,lng:c.x}),h=p.y-5E-5,r=c.y+5E-5,q=c.x-5E-5;c=p.x+5E-5;var s=2*Math.PI,v=Math.PI/4,m=Math.floor(0.5+7/(19-g)),C=window.JSON.parse,D=this.site.symbology,E=Math.floor(30/(22-g))/10,H=E/2,I=256*Math.pow(2,g),M=d.width/Math.abs(c-q),O=d.height/Math.abs(r-h),A=this.map._initialTopLeftPoint.x,N=this.map._initialTopLeftPoint.y,P=Math.PI/180;d=100/M;var J=[],K=[],G=[q-d,c+d,h-d,r+d,g,g];d={ymin:h,ymax:r,xmin:q,xmax:c};var y=
" SELECT * FROM ASSETS ",y=y+" WHERE ( xmax > ? AND ? > xmin AND ymax > ? AND ? > ymin) ",y=y+"      AND ( (minzoom <= 1*? and maxzoom >= 1*? ) or (minzoom IS NULL OR maxzoom IS NULL) ) ";this.active_layers&&(y+=this.active_layers.length?' and (symbolId like "'+this.active_layers.join('%" or symbolId like "')+'%" )':" and 1=2 ");for(i=0;i<this.site.zones.length;i++)this.extents_match(this.site.zones[i].extent,d)&&(l&&b.benchStart(this.site.zones[i].database_name),function(c){a.openDatabase({name:c.database_name,
bgType:1}).transaction(function(a){a.executeSql(y,G,function(a,d){for(var h=d.rows,p=0,f=h.length;p<f;p++){var z=!1,y=!1,w=h.item(p),x=C(w.geometry),B=D[w.symbolId],t,u;"MultiLineString"===x.type&&(x.coordinates=x.coordinates[0]);if("LineString"===x.type){e.beginPath();for(var w=0,G=x.coordinates.length;w<G;w++){t=x.coordinates[w];15>g?(u=Math.floor(0.5+(t[0]-q)*M),t=Math.floor(0.5+(r-t[1])*O)):(u=0.017453292519943295*t[0],t=Math.log(Math.tan(v+0.008726646259971648*t[1])),u=I*(0.15915494309189535*
u+0.5),t=I*(-0.15915494309189535*t+0.5),u=Math.floor(0.5+u)-A-n.x,t=Math.floor(0.5+t)-N-n.y);if(!1===z)e.moveTo(u,t);else if(u===z&&t===y)continue;else e.lineTo(u,t);z=u;y=t}e.strokeStyle=B.style.strokecolor;e.stroke()}else"Point"===x.type?(u=0.017453292519943295*x.coordinates[0],t=Math.log(Math.tan(v+0.008726646259971648*x.coordinates[1])),u=I*(0.15915494309189535*u+0.5),t=I*(-0.15915494309189535*t+0.5),u=Math.floor(0.5+u)-A-n.x,t=Math.floor(0.5+t)-N-n.y,(z=D[w.symbolId.toString()].style.image)?
(e.save(),e.translate(u,t),e.rotate(-w.angle*P),e.drawImage(z,-z.width*H,-z.height*H,z.width*E,z.height*E),e.restore(),16<g&&w.maplabel&&K.push({txt:w.maplabel,x:u,y:t,size:z.width})):(e.beginPath(),e.arc(u,t,m,0,s,!0),e.fillStyle=D[w.symbolId].style.fillcolor,e.fill(),e.fillText(w.maplabel,u+1,t+1))):console.log("g\u00e9ometrie inconnue")}if(16<g){h=e.lineWidth;e.strokeStyle="white";e.lineWidth=4;p=0;for(f=K.length;p<f;p++)a:{B=K[p],u=e;z=B.txt;y=B.size;x=B.x;B=B.y;t=void 0;w=0;for(G=J.length;w<
G;w++)if(t=J[w],x<t.x+t.width+15&&x>t.x-15&&B<t.y+15&&B>t.y-15)break a;J.push({x:x,y:B,width:u.measureText(z).width});u.font=y/2+"px Arial";u.strokeText(z,x+y*H+1,B);u.fillText(z,x+y*H+1,B)}e.lineWidth=h}l&&b.benchStop(c.database_name)},function(a){console.log(JSON.stringify(a))})})}(this.site.zones[i]))}};return b}]);
angular.module("smartgeomobile").factory("GiReportBuilder",["$templateCache",function(a){return{_buildField:function(a,m,b){m="report.activity.tabs["+a+"].fields["+m+"]";if(b.readonly)return a='<p><b class="ro-label">'+b.label+"</b>",a+='<span class="ro-value">{{report.roFields['+b.id+"]}}</span></p>";a='<p ng-form="validatorForm"                          ng-show="'+m+'.visible !== false"                          class="'+(!1===b.visible?"isconsequence":"")+'">';a+='<label class="control-label'+("O"==
b.type?" prettycheckbox":"")+'" ';"O"==b.type&&(a+=' ng-class="{checked: report.fields['+b.id+"] == 'Y'}\"");a=a+">"+b.label;a+='<span class="required-marker icon-asterisk" ng-show="'+m+'.required"></span>';var f=b["default"]&&b["default"].pkey?"report.overrides["+b.id+"]":"report.fields["+b.id+"]",c=b["default"]&&b["default"].pkey?"{{report.roFields["+b.id+"]}}":"";switch(b.type){case "D":a+='<input class="form-control"                                          ng-required="'+m+'.required"                                          type="date"                                          name="f"                                          placeholder="'+
c+'"                                          ng-model = "'+f+'"></input>';break;case "T":a+='<input class="form-control"                                          ng-required="'+m+'.required"                                          type="time"                                          name="f"                                              placeholder="'+c+'"                                          ng-model = "'+f+'"></input>';break;case "N":a+='<input class="form-control"                                          ng-required="'+
m+'.required"                                          ng-pattern="numberPattern"                                         type="number"                                          name="f"                                          placeholder="'+c+'"                                          ng-model = "'+f+'"></input>                                  <small class="helper-text" ng-show="validatorForm.f.$error.number">                                      Cette valeur doit \u00eatre un nombre.                                  </small>';
break;case "L":a+='<select class="form-control"                                           name="f"                                           ng-required="'+m+'.required"                                           ng-model = "report.fields['+b.id+']">';a+="<option></option>";for(k in b.options)a+='<option value="'+b.options[k].value+'">'+b.options[k].label+"</option>";a+="</select>";break;case "O":a+='<span><span class="icon-check pull-left yes" ></span><span class="icon-check-empty pull-left no" ></span>';
a+='<input type="checkbox"                                      class="form-control"                                      ng-model="report.fields['+b.id+']"                                      ng-click="applyConsequences('+b.id+')"                                      ng-true-value="Y"                                      ng-false-value="N"></input>';a+="</span>";break;default:a+='<input ng-required="'+m+'.required"                                      class="form-control"                                      type="text"                                      name="f"                                      placeholder="'+
c+'"                                      ng-model = "'+f+'"></input>'}a+="</label>";return a+="</p>"},_buildTab:function(a,m){var b;b='<div class="panel panel-default report"><div class="panel-heading"><h4 class="panel-title">'+('        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#report-collapse-'+a+'"');b+='           ng-click="toggleCollapse($event)">';b+=m.label;b+="</a></h4></div>";b+='<div id="report-collapse-'+a+'" class="panel-collapse'+("0"!==""+a?
" collapse":"")+'">';b+='<div class="panel-body">';for(var f in m.fields)b+=this._buildField(a,f,m.fields[f]);return b+="</div></div></div>"},buildTemplate:function(a){var m="",b;for(b in a.tabs)m+=this._buildTab(b,a.tabs[b]);return m},alreadyBuilt:!1,buildAllTemplates:function(d){if(!this.alreadyBuilt){var m,b;for(b in d)m=d[b],a.put("report-"+m.id+".html",this.buildTemplate(m))}}}}]);
angular.module("smartgeomobile").factory("Installer",["SQLite","Smartgeo","G3ME","$http","$rootScope",function(a,d,m,b,f){var c={deleteAssets:function(l,b,g){var h=[],d;for(d in b)b.hasOwnProperty(d)&&(h=h.concat(b[d]));if(0>=h.length)g();else{var n=" DELETE FROM ASSETS WHERE id in ( "+h.join(",")+" ) ";console.log(n);for(b=0;b<l.zones.length;b++)a.openDatabase({name:l.zones[b].database_name}).transaction(function(a){a.executeSql(n,[],function(){c.checkpoint("_remove_assets_",l.zones.length,g)})})}},
formatSiteMetadata:function(a,c){for(var b={},h={},d={},n=[],f=[],q=0,q=0;q<a.metamodel.length;q++)if(c||0!=a.number[a.metamodel[q].okey])b[a.metamodel[q].okey]=a.metamodel[q];a.metamodel=b;n._byId=[];for(q=0;q<a.activities.length;q++)if(c||0!=a.number[a.activities[q].okeys[0]])n.push(a.activities[q]),n._byId[a.activities[q].id]=a.activities[q];a.activities=n;for(var s in a.lists)a.lists.hasOwnProperty(s)&&(h[s]=a.lists[s]);a.lists=h;for(q=0;q<a.symbology.length;q++)d[a.symbology[q].okey+""+a.symbology[q].classindex+
""]=a.symbology[q];a.symbology=d;for(var v in a.number)a.number.hasOwnProperty(v)&&"total"!==v&&0!=a.number[v]&&f.push({okey:v,amount:a.number[v]});a.stats=f;return a},getInstallJSON:function(a,c){var g=d.getServiceUrl("gi.maintenance.mobility.installation.json",{site:a.id});b.get(g).success(c)},getUpdateJSON:function(a,c){var g=d.getServiceUrl("gi.maintenance.mobility.installation.json",{site:a.id,timestamp:a.timestamp});b.get(g).success(c)},saveSite:function(a){var c=d.get("sites")||{};c[a.id]=
a;d.set("sites",c)},createZones:function(b,e){var g=Math.ceil(Math.sqrt(Math.pow(2,Math.ceil(Math.log(b.number.total/d._INSTALL_MAX_ASSETS_PER_ZONE)/Math.LN2)))),g=Math.min(g,d._INSTALL_MAX_ZONES_MATRIX_LENGTH);zones_matrix_width=(b.extent.xmax-b.extent.xmin)/g;zones_matrix_height=(b.extent.ymax-b.extent.ymin)/g;b.zones=[];for(var h=0;h<g;h++)for(var p=0;p<g;p++)extent={xmin:b.extent.xmin+h*zones_matrix_width,xmax:b.extent.xmin+(h+1)*zones_matrix_width,ymin:b.extent.ymin+p*zones_matrix_height,ymax:b.extent.ymin+
(p+1)*zones_matrix_height},b.zones.push({extent:extent,assets:[],insert_requests:[],table_name:JSON.stringify(extent).replace(/\.|-|{|}|,|:|xmin|xmax|ymin|ymax|"/g,""),database_name:JSON.stringify(extent).replace(/\.|-|{|}|,|:|xmin|xmax|ymin|ymax|"/g,"")});for(h=0;h<b.zones.length;h++)a.openDatabase({name:b.zones[h].database_name}).transaction(function(a){a.executeSql("DROP TABLE IF EXISTS ASSETS");a.executeSql("CREATE TABLE IF NOT EXISTS ASSETS (id, xmin real, xmax real, ymin real, ymax real, geometry, symbolId,  angle, label, maplabel, minzoom integer, maxzoom integer, asset)");
a.executeSql("CREATE INDEX IF NOT EXISTS IDX_ASSETS ON ASSETS (xmin , xmax , ymin , ymax, symbolId , minzoom , maxzoom)",[],function(){c.checkpoint("create_zones_databases_",b.zones.length,e)})});return b},checkpoint:function(a,b,g){c[a]=1*(c[a]||0)+1;return c[a]>=b?(c[a]=0,g()):!1},install:function(a,b,g,h){if(!b.length)return g();c.installOkey(a,b[0],function(){c.install(a,b.slice(1),g)},h)},update:function(a,b,g){c.deleteAssets(a,a.obsoletes,function(){c.install(a,b,g,!0)})},installOkey:function(a,
e,g,h){f.$broadcast("_INSTALLER_I_AM_CURRENTLY_DOING_THIS_",{okey:e.okey,progress:0});if(e.amount>d._INSTALL_MAX_ASSETS_PER_HTTP_REQUEST)c.installOkeyPerSlice(a,e,0,g,h);else{var p=d.get("url")+"gi.maintenance.mobility.installation.assets.json&okey="+e.okey;h&&(p+="&timestamp="+a.oldTimestamp);b.get(p).success(function(b){c.save(a,b.assets,function(){f.$broadcast("_INSTALLER_I_AM_CURRENTLY_DOING_THIS_",{okey:e.okey,progress:e.amount});g()})}).error(function(){c.installOkey(a,e,g)})}},installOkeyPerSlice:function(a,
e,g,h,p){if(g>=e.amount)return h();var n=g+d._INSTALL_MAX_ASSETS_PER_HTTP_REQUEST,r=d.get("url")+"gi.maintenance.mobility.installation.assets.json",r=r+("&okey="+e.okey),r=r+("&min="+(g+1))+("&max="+n);p&&(r+="&timestamp="+a.oldTimestamp);b.get(r).success(function(b){c.save(a,b.assets,function(){f.$broadcast("_INSTALLER_I_AM_CURRENTLY_DOING_THIS_",{okey:e.okey,progress:Math.min(n,e.amount)});c.installOkeyPerSlice(a,e,n,h)})}).error(function(){c.installOkeyPerSlice(a,e,n,h)})},save:function(a,b,g){c.distribute_assets_in_zones(a,
b);c.save_zones_to_database(a,function(){c.clean_zones(a);g()})},clean_zones:function(a){for(var b=0;b<a.zones.length;b++)a.zones[b].assets&&(a.zones[b].assets_count=(a.zones[b].assets_count||0)+a.zones[b].assets.length,a.zones[b].assets=[],a.zones[b].insert_requests=[])},distribute_assets_in_zones:function(a,b){if(!b)return!1;for(var c,h,d=a.zones,n=0,f=b.length;n<f;n++)if((c=b[n])&&c.bounds){h=c.bounds;h={xmin:h.sw.lng,xmax:h.ne.lng,ymin:h.sw.lat,ymax:h.ne.lat};for(var q=0,s=d.length;q<s;q++)m.extents_match(d[q].extent,
h)&&d[q].assets.push(c)}},save_zones_to_database:function(a,b){for(var g=0;g<a.zones.length;g++)(function(g){var f,n=a.zones[g];if(n.assets)g=n.assets;else return c.checkpoint("saved_zones",a.zones.length,b);for(;g.length;)f=g.slice(0,d._INSTALL_MAX_ASSETS_PER_INSERT_REQUEST),n.insert_requests.push(c.build_binded_insert_request(a,f)),g=g.slice(d._INSTALL_MAX_ASSETS_PER_INSERT_REQUEST);c.execute_requests_for_zone(a,n,function(){c.checkpoint("saved_zones",a.zones.length,b)})})(g)},execute_requests_for_zone:function(b,
e,g){if(0===e.insert_requests.length)return c.checkpoint("rqst"+e.table_name,e.insert_requests.length,g);for(b=0;b<e.insert_requests.length;b++)(function(b,e){a.openDatabase({name:b.database_name}).transaction(function(a){a.executeSql(e.request,e.args,function(){c.checkpoint("rqst"+b.table_name,b.insert_requests.length,g)},function(){c.checkpoint("rqst"+b.table_name,b.insert_requests.length,g)})})})(e,e.insert_requests[b])},build_binded_insert_request:function(a,b){var c="",d,f,n,r=a.metamodel,q=
a.symbology,s,v=[],m="xmin xmax ymin ymax geometry symbolId angle label maplabel minzoom maxzoom asset".split(" "),C=b.length,D,E;for(D=0;D<C;D++){f=d=b[D];n=d.guid;s=d.bounds;c+=(""===c?"INSERT INTO ASSETS SELECT ":" UNION SELECT ")+" ? as id ";for(E=0;E<m.length;E++)c+=" , ? as "+m[E];v.push(n,s.sw.lng,s.ne.lng,s.sw.lat,s.ne.lat,JSON.stringify(d.geometry),""+d.okey+d.classindex,d.angle||"",""+(d.attributes[r[d.okey].ukey]||""),d.maplabel||"",1*q[""+d.okey+d.classindex].minzoom,1*q[""+d.okey+d.classindex].maxzoom,
JSON.stringify(f));b[D]&&delete b[D]}return{request:""!==c?c:"SELECT 1",args:v}},uninstallSite:function(b,e){for(var g=0;g<b.zones.length;g++)a.openDatabase({name:b.zones[g].database_name}).transaction(function(a){a.executeSql("DROP TABLE IF EXISTS ASSETS",[],function(){c.checkpoint("destroy_zones_databases",b.zones.length,e)},d.log)})}};return c}]);
angular.module("smartgeomobile").factory("SQLite",function(){return{DATABASE_SIZE:52428800,DATABASE_VERSION:"0.0.1-angular",openDatabase:function(a){return this._isRunningOnMobile()?window.sqlitePlugin.openDatabase(a.name,this.DATABASE_VERSION,a.name,this.DATABASE_SIZE):window.openDatabase(a.name,this.DATABASE_VERSION,a.name,this.DATABASE_SIZE)},_isRunningOnMobile:function(){var a=!1,d=navigator.userAgent||navigator.vendor||window.opera;if(/(android|ipad|playbook|silk|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(d)||
/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(d.substr(0,
4)))a=!0;return a}}});
angular.module("smartgeomobile").factory("Smartgeo",["SQLite","$http","$window","$rootScope",function(a,d,m,b){var f={_MAP_MAX_ZOOM:20,_MAP_MIN_ZOOM:13,_INSTALL_MAX_ASSETS_PER_HTTP_REQUEST:1E3,_INSTALL_MAX_ASSETS_PER_ZONE:2048,_INSTALL_MAX_ASSETS_PER_INSERT_REQUEST:60,_INSTALL_MAX_ASSETS_PER_DELETE_REQUEST:999,_INSTALL_MAX_ZONES_MATRIX_LENGTH:4,_SMARTGEO_MOBILE_VERSION:"0.9.2",_G3ME_VERSION:"0.1.0",setGimapUrl:function(){var a=prompt("URL GiMAP",f.get("url")||"");if(!a&&null!==a)return this.setGimapUrl();
if(null===a)return null;-1===a.indexOf("http")&&(a="http://"+a);-1===a.indexOf("index.php?service=")&&(a+="/index.php?service=");f.reset();return this.set("url",a)},reset:function(){localStorage.clear()},log:function(){console.log(arguments)},getServiceUrl:function(a,b){var d=f.get("url"),d=d+a,g;for(g in b)b.hasOwnProperty(g)&&(d+="&"+g+"="+b[g]);return d},ping:function(a){a=a||function(){};d.post(f.getServiceUrl("global.dcnx.json")).success(function(b){f.set("online",!0);a(!0)}).error(function(){f.set("online",
!1);a(!1)})},_isRunningOnMobile:function(){var a=!1,b=navigator.userAgent||navigator.vendor||window.opera;if(/(android|ipad|playbook|silk|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,
4)))a=!0;return a},findAssetsByGuids:function(b,d,e,g,f){g||(g=b.zones,f=[]);if(!g||!g.length)return e(f);"object"!==typeof d&&(d=[d]);if(0===d.length)return e([]);var p=[],n=this,r="SELECT * FROM ASSETS ",q;for(q=0;q<d.length;q++)r+=0===q?" WHERE ":" or ",r+=" (id like ? or id = ? ) ",p.push(1*d[q],1*d[q]);console.log("Attention, j'ouvre la base !");a.openDatabase({name:g[0].database_name}).transaction(function(a){console.log("C'est bon c'est ouvert. Je transactionne ...");a.executeSql(r,p,function(a,
q){console.log("C'est bon j'ai "+q.rows.length+" resultat(s)");for(var s=0;s<q.rows.length;s++){var p=q.rows.item(s);p.okey=JSON.parse(p.asset.replace(RegExp("\n","g")," ")).okey;f.push(p)}n.findAssetsByGuids(b,d,e,g.slice(1),f)},function(a){console.log(JSON.stringify(a))})},function(a){console.log(JSON.stringify(a))})},findAssetsByOkey:function(b,d,e,g,h){g||(g=b.zones,h=[]);if(!g.length)return e(h);var p=this;a.openDatabase({name:g[0].database_name}).transaction(function(a){a.executeSql("SELECT * FROM ASSETS WHERE symbolId like ? or symbolId = ?",
[d+"%",d+"%"],function(a,q){for(var f=0;f<q.rows.length;f++){var n=q.rows.item(f);n.okey=JSON.parse(n.asset.replace(RegExp("\n","g")," ")).okey;h.push(n)}p.findAssetsByOkey(b,d,e,g.slice(1),h)},f.log,f.log)},f.log)},findAssetsByLabel:function(b,d,e,g,h){g||(g=b.zones,h=[]);if(!g.length)return e(h);var p=this;a.openDatabase({name:g[0].database_name}).transaction(function(a){a.executeSql("SELECT * FROM ASSETS WHERE label like ? or label = ?",[d+"%",d+"%"],function(a,q){for(var f=0;f<q.rows.length;f++){var n=
q.rows.item(f);n.okey=JSON.parse(n.asset.replace(RegExp("\n","g")," ")).okey;h.push(n)}p.findAssetsByLabel(b,d,e,g.slice(1),h)},f.log,f.log)},f.log)},findAssetsByCriteria:function(b,d,e,g,h,p){g||(g=b.zones,h=[]);if(!g.length)return e(h);if(!p){p="SELECT * FROM ASSETS WHERE ";var n="",r;for(r in d.criteria)d.criteria.hasOwnProperty(r)&&d.criteria[r]&&(n=isNaN(1*d.criteria[r])?'"':"",p+=" (     asset like '%\""+r+'":'+n+d.criteria[r]+n+",%'       ",p+="   OR  asset like '%\""+r+'":'+n+d.criteria[r]+
n+"}%' ) AND ");p+=" 1 LIMIT 0, 10"}a.openDatabase({name:g[0].database_name}).transaction(function(a){a.executeSql(p,[],function(a,q){for(var n=0;n<q.rows.length;n++){var r=q.rows.item(n);r.okey=JSON.parse(r.asset.replace(RegExp("\n","g")," ")).okey;h.push(r)}f.findAssetsByCriteria(b,d,e,g.slice(1),h,p)},f.log,f.log)},f.log)},_initializeGlobalEvents:function(){window.addEventListener("online",function(a){setTimeout(function(){f.set("online",!0);b.$broadcast("DEVICE_IS_ONLINE");console.log("broadcasting DEVICE_IS_ONLINE");
f.silentLogin()},1E3)},!1);window.addEventListener("offline",function(a){f.set("online",!1);b.$broadcast("DEVICE_IS_OFFLINE");console.log("broadcasting DEVICE_IS_OFFLINE")},!1)},silentLogin:function(){var a=f.get("user")||{};a.token?f.login(token):a.username&&a.password&&f.login(a.username,a.password)},login:function(a,b,e,g){var h;"function"===typeof b&&(h=a,g=e,e=b);a=h?f.getServiceUrl("global.auth.json",{token:encodeURIComponent(h)}):f.getServiceUrl("global.auth.json",{login:encodeURIComponent(a),
pwd:encodeURIComponent(b)});d.post(a).success(e||function(){}).error(g||function(){})},get:function(a){return JSON.parse(localStorage.getItem(a))},set:function(a,b){return localStorage.setItem(a,JSON.stringify(b))},unset:function(a){return localStorage.removeItem(a)}};f.get("url")||f.setGimapUrl();f._initializeGlobalEvents();return f}]);
angular.module("smartgeomobile").controller("authController",["$scope","$rootScope","$http","$location","$window","Smartgeo","SQLite",function(a,d,m,b,f,c,l){function e(){a.readyToLog=!1;a.logMessage="V\u00e9rification du serveur";c.ping(function(b){a.logMessage="Connexion "+(b?"distante":"locale");a.readyToLog=!0})}function g(a,b){403===b?f.alert("Mot de passe incorrecte pour l'utilisateur "+a.login):""===b?f.alert("L'application n'est pas parvenue \u00e0 joindre le serveur."):f.alert("Connexion au serveur impossible ("+
b+")");e()}function h(){a.readyToLog=!1;a.logMessage="Veuillez patienter...";c.login(encodeURIComponent(a.username),encodeURIComponent(a.pwd),function(){var d=c.get("knownUsers")||{};d[a.username]=a.pwd;c.set("knownUsers",d);p.password!==a.pwd&&(d=confirm("Souhaitez-vous que l'application retienne votre mot de passe ?"),p={password:d?a.pwd:"",rememberme:d});p.username=a.username;c.set("user",p);b.path("sites")},g)}var p=c.get("user")||{username:"",password:"",rememberme:!0};a.version=c._SMARTGEO_MOBILE_VERSION;
a.username=p.username;a.pwd=p.password;a.readyToLog=!1;a.logMessage="V\u00e9rification du serveur";a.gimapUrl=c.get("url");a.smallUrl=(a.gimapUrl||"").replace(/^https?:\/\/(.+)\/index\.php.*$/,"$1");a.$on("DEVICE_IS_ONLINE",e);a.$on("DEVICE_IS_OFFLINE",e);e();a.login=function(){a.username=a.username.trim();a.pwd=a.pwd.trim();if(!a.username.length||!a.pwd.length)return f.alert("Veuillez renseigner un nom d'utilisateur et un mot de passe."),!1;!0===c.get("online")?h():(c.get("knownUsers")||{})[a.username]===
a.pwd?b.path("sites"):f.alert("Le mode d\u00e9connect\u00e9 n'est pas disponible pour cet utilisateur car il ne s'est jamais authentifi\u00e9 en mode connect\u00e9.")};a.setGimapUrl=function(){null!==c.setGimapUrl()&&(a.username="",a.pwd="",a.gimapUrl=c.get("url"),a.smallUrl=(a.gimapUrl||"").replace(/^https?:\/\/(.+)\/index\.php.*$/,"$1"),e(),c.unset("sites"),c.unset("knownUsers"))};a.forgetPassword=function(){a.username=a.pwd="";c.unset("user")}}]);
angular.module("smartgeomobile").controller("consultationController",["$scope","$rootScope","$window",function(a,d,m){a.state="closed";a.loading=!1;var b;a.$on("CONSULTATION_CLICK_REQUESTED",function(){b&&clearTimeout(b);b=setTimeout(function(){a.loading=!0;a.state="open";a.$apply()},200)});a.$on("CONSULTATION_CLICK_CANCELLED",function(){b&&clearTimeout(b);a.state="closed";a.loading=!1;a.$apply()});a.$on("UPDATE_CONSULTATION_ASSETS_LIST",function(f,c){b&&clearTimeout(b);a.groups={};a.assets=c;a.assets._byGuid=
[];for(var l=0;l<c.length;l++)a.groups[c[l].priority]||(a.groups[c[l].priority]={}),a.groups[c[l].priority][c[l].okey]||(a.groups[c[l].priority][c[l].okey]={}),a.assets._byGuid[c[l].guid]=c[l],a.groups[c[l].priority][c[l].okey][c[l].guid]=c[l];a.state="open";a.loading=!1;a.$apply();d.$broadcast("UNHIGHALLLIGHT_ASSET");$(".collapse").collapse({toggle:!1}).on("show.bs.collapse",function(){d.$broadcast("HIGHLIGHT_ASSET",a.assets._byGuid[this.id.match(/collapse-(.*)/)[1]])}).on("hide.bs.collapse",function(){d.$broadcast("UNHIGHLIGHT_ASSET",
a.assets._byGuid[this.id.match(/collapse-(.*)/)[1]])})});a.close=function(){a.state="closed"};a.locateAsset=function(a){d.$broadcast("LOCATE_ASSET",a)};a.zoomOnAsset=function(b){d.$broadcast("ZOOM_ON_ASSET",b);400>m.document.width&&(a.state="closed")};a.toggleConsultationPanel=function(){a.state="open"===a.state?"closed":"open"};a.toggleCollapse=function(a){a.preventDefault()};a.definedFilter=function(a){console.log(a);return!0}}]);
angular.module("smartgeomobile").controller("intentController",["$scope","$routeParams","$location","$rootScope","Smartgeo","$http","$window","G3ME",function(a,d,m,b,f,c,l,e){function g(a,b){f.getServiceUrl("global.auth.json",{token:a});var c=f.get("user")||{};c.token=a;f.set("user",c);return b()}function h(){switch(a.controller){case "map":m.path("map/"+b.site.id);a.$$phase||a.$apply();break;case "report":m.path("report/"+b.site.id+"/"+b.report_activity+"/"+b.target+"/");a.$$phase||a.$apply();break;
default:l.alert("Controller introuvable ("+d.controller+")")}}a.controller=d.controller;if(!a.controller)return!1;if(!b.site)if(d.site)b.site=b.site||f.get("sites")[d.site];else{c=f.get("sites");for(var p in c)if(c.hasOwnProperty(p)){b.site=c[p];break}}if(!b.site)return l.alert("Aucun site n'est disponible."),m.path("#"),!1;for(var n in d)d.hasOwnProperty(n)&&"controller"!==n&&"token"!==n&&(b[n]=d[n]);b.map_target?e.parseTarget(b.site,b.map_target,function(c){if(!c.length)return l.alert("L'objet n'a pas \u00e9t\u00e9 trouv\u00e9 dans la base de donn\u00e9es du terminal."),
g(d.token,h);b.map_target=c;if("true"===b.map_marker||!0===b.map_marker){if(b.map_marker=L.marker(b.map_target),b.report_target&&b.report_activity)b.map_marker.on("click",function(){m.path("/report/"+b.site.id+"/"+b.report_activity+"/"+b.report_target);a.$apply();a.$$phase||a.$apply()})}else b.map_marker=void 0;g(d.token,h)}):g(d.token,h)}]);
angular.module("smartgeomobile").controller("layersController",["$scope","G3ME",function(a,d){function m(a){var b=!1,c=a.layers,d;for(d in c)b=b||c[d].status;a.status=b}a.mlPushMenu=new mlPushMenu(document.getElementById("mp-menu"),document.getElementById("trigger"),{type:"cover"});var b={},f,c={},l,e=d.getVisibility(),g;for(g in a.site.metamodel)f=a.site.metamodel[g],f.group in b||(b[f.group]={label:f.group,status:!0,layers:[]}),l={status:!1===e||!!e[f.okey],label:f.label,okey:f.okey},b[f.group].layers.push(l),
c[f.okey]=l;for(g in b)m(b[g]);a.groups=b;a.layers=c;a.refreshView=function(){for(var b in a.groups)m(a.groups[b]);d.setVisibility(a.layers)};a.updateGroups=function(b){var c=a.groups[b];b=c.status;var c=c.layers,d;for(d in c)c[d].status=b;a.refreshView()}}]);
angular.module("smartgeomobile").controller("mapController",["$scope","$routeParams","$window","$rootScope","SQLite","G3ME","Smartgeo","$location",function(a,d,m,b,f,c,l,e){function g(){var a=L.popup().setLatLng(coords).setContent("<p>Aucun patrimoine dans cette zone.</p>").openOn(c.map);setTimeout(function(){$(a._container).fadeOut()},3E3);b.$broadcast("CONSULTATION_CLICK_CANCELED");return!1}function h(a,b,c){return new (L.Control.extend({options:{position:"topright"},onAdd:function(d){d=L.DomUtil.create("div",
"leaflet-bar");$(d).html('<a href="#" title="'+a+'"><span class="icon '+b+'"></span></a>').on("click",c);return d}}))}function p(){c.map.stopLocate();F&&c.map.removeControl(F);n();return!1}function n(){s&&s._map&&c.map.removeLayer(s);v&&v._map&&c.map.removeLayer(v)}function r(a){c.map.off("locationfound",r);n();s=new L.Circle(a.latlng,a.accuracy,{clickable:!1,color:"#fd9122",opacity:0.1,fillOpacity:0.05});s.addTo(c.map);$(s._path).fadeOut(1500,function(){c.map.removeLayer(s)});"heading"in a&&(v=new L.Marker(a.latlng,
{icon:L.divIcon({className:"gi-compass"})}),v.addTo(c.map),v._icon.innerHTML="<div></div>",v._icon.firstChild.style.WebkitTransform="rotate("+a.heading+"deg)")}function q(){a.consultationIsEnabled=!1;C&&C._map&&c.map.removeControl(C);return!1}window.site=b.site=b.site||l.get("sites")[d.site];if(!b.site)return m.alert("Aucun site n'est disponible."),e.path("#"),!1;a.consultationIsEnabled=!1;c.initialize("smartgeo-map",b.site,b.map_target||l.get("lastLeafletMapExtent")||[],b.map_marker);c.map.on("moveend",
function(a){a=c.map.getBounds();a._northEast.lat==a._southWest.lat&&a._northEast.lng==a._southWest.lng||l.set("lastLeafletMapExtent",[[a._northEast.lat,a._northEast.lng],[a._southWest.lat,a._southWest.lng]])});c.map.on("click",function(d){if(!a.consultationIsEnabled)return!1;b.$broadcast("CONSULTATION_CLICK_REQUESTED");d=d.latlng;var e=40*(40075017*Math.cos(L.LatLng.DEG_TO_RAD*d.lat)/Math.pow(2,c.map.getZoom()+8)),q=(new L.Circle(d,e,{color:"#fc9e49",weight:1})).addTo(c.map),e=q.getBounds();d=e.getNorthWest();
var e=e.getSouthEast(),n=d.lng,h=e.lng,p=e.lat,s=d.lat,m,r="";d=0;for(e=b.site.zones.length;d<e&&(m=b.site.zones[d],!c.extents_match(m.extent,{xmin:n,ymin:p,xmax:h,ymax:s}));d++);if(!m)return g();r+="SELECT asset, label, geometry, CASE WHEN geometry like '%Point%' THEN 1 WHEN geometry like '%LineString%' THEN 2 END as priority FROM ASSETS WHERE (((ymin <= ? AND ymin >= ?) OR (ymax <= ? AND ymax >= ?)) ";r+=" AND ((xmin <= ? AND xmin >= ?) OR (xmax <= ? AND xmax >= ?)) ";r+=" OR ( xmin <=  ? AND ymin <= ? AND xmax >= ? AND ymax >= ? )) ";
r+=" order by priority LIMIT 0,10 ";$(q._path).fadeOut(1500,function(){c.map.removeLayer(q)});f.openDatabase({name:m.database_name,bgType:1}).transaction(function(a){a.executeSql(r,[s,p,s,p,h,n,h,n,n,p,h,s],function(a,c){if(0===c.rows.length)return g();for(var d=[],e,q,f=0;f<c.rows.length;f++)q=c.rows.item(f),e=JSON.parse(q.asset),e.label=q.label,e.geometry=JSON.parse(q.geometry),e.priority=q.priority,d.push(e);b.$broadcast("UPDATE_CONSULTATION_ASSETS_LIST",d)},l.log)});return!1});a.$on("ACTIVATE_CONSULTATION",
function(b){q();a.consultationIsEnabled=!0;C||(C=h("Consultation","icon-info-sign",q));c.map.addControl(C)});a.$on("ACTIVATE_POSITION",function(a){a&&a.preventDefault();p();F||(F=h("Ma position","icon-compass",p));c.map.addControl(F);c.map.on("locationfound",r);c.map.locate({watch:!0,setView:!0})});a.$on("HIGHLIGHT_ASSET",function(b,c){a.highlightAsset(c)});a.$on("UNHIGHLIGHT_ASSET",function(b,c){a.unHighlightAsset(c)});a.$on("UNHIGHALLLIGHT_ASSET",function(b){a.unHighlightAllAsset()});a.$on("ZOOM_ON_ASSET",
function(b,c){a.zoomOnAsset(c)});var s,v,F,C;a.highlightAsset=function(b,d,g){g=g||function(){a.zoomOnAsset(b)};c.assetsMarkers[b.guid]&&c.map.removeLayer(c.assetsMarkers[b.guid]);switch(b.geometry.type){case "Point":var e=b.geometry.coordinates;c.assetsMarkers[b.guid]=d||L.marker([e[1],e[0]]);break;case "LineString":c.assetsMarkers[b.guid]=d||L.geoJson(b.geometry,{style:{color:"#fc9e49",opacity:0.9,weight:7}});break;default:console.log("Geometrie non support\u00e9e")}c.assetsMarkers[b.guid].on("click",
g);c.assetsMarkers[b.guid].addTo(c.map);c.invalidateMapSize()};a.unHighlightAsset=function(a){c.assetsMarkers[a.guid]&&c.map.removeLayer(c.assetsMarkers[a.guid]);c.invalidateMapSize()};a.unHighlightAllAsset=function(){for(var a=0;a<c.assetsMarkers.length;a++)c.assetsMarkers[a]&&c.map.removeLayer(c.assetsMarkers[a]);c.invalidateMapSize()};a.zoomOnAsset=function(a){var b=a.geometry.coordinates,d;switch(a.geometry.type){case "Point":d=[b[1],b[0]];break;case "LineString":d=[b[0][1],b[0][0]];break;case "MultiLineString":d=
[b[0][0][1],b[0][0][0]];break;default:console.log("Geometrie non support\u00e9e")}c.map.setView(d,18);c.invalidateMapSize()}}]);
angular.module("smartgeomobile").controller("menuController",["$scope","$routeParams","$window","$rootScope","Smartgeo","SQLite",function(a,d,m,b,f,c){function l(){a.toSyncNumber=(f.get("reports")||[]).length;a.$$phase||a.$apply()}a.mlPushMenu=new mlPushMenu(document.getElementById("mp-menu"),document.getElementById("trigger"),{type:"cover"});m.document.addEventListener("menubutton",function(){a.mlPushMenu._openMenu()},!1);m.document.addEventListener("backbutton",function(b){var c=a.mlPushMenu;c.level--;
0===c.level?c._resetMenu():c._closeMenu();b.preventDefault();return!1},!1);a.close=function(){a.mlPushMenu._resetMenu()};l();a.$on("REPORT_LOCAL_NUMBER_CHANGE",l);a.activateConsultation=function(c){c.preventDefault();b.$broadcast("ACTIVATE_CONSULTATION");a.close()};a.activatePosition=function(c){c.preventDefault();b.$broadcast("ACTIVATE_POSITION");a.close()}}]);
angular.module("smartgeomobile").controller("reportController",["$scope","$routeParams","$window","$rootScope","Smartgeo","$location","$http","GiReportBuilder","G3ME",function(a,d,m,b,f,c,l,e,g){function h(b){var c=a.report.activity,d,g,e,f,n;d=0;for(g=c.tabs.length;d<g;d++)for(n=c.tabs[d],e=0,f=n.fields.length;e<f;e++)if(n.fields[e].id==b)return n.fields[e];return!1}function p(){function c(a){return 10>a?"0"+a:a}function d(a,c){for(var g={},e,f=0,q=n.length;f<q;f++){e=JSON.parse(n[f].asset).attributes;
var h;a:{h=b.site.metamodel[c];var p=void 0;for(p in h.tabs)for(var l in h.tabs[p].fields)if(h.tabs[p].fields[l].key==a){h=h.tabs[p].fields[l].options;break a}h=!1}e=e[a];h&&b.site.lists[h]&&b.site.lists[h][e]&&(e=b.site.lists[h][e]);g[n[f].id]=e}return g}var g=a.report,e=g.activity,f=g.fields,n=g.assets,h,p,l,r,m,A,g=0;for(p=e.tabs.length;g<p;g++)for(m=e.tabs[g],l=0,r=m.fields.length;l<r;l++)A=m.fields[l],h=A["default"],a["report_fields["+A.label+"]"]&&(h=a["report_fields["+A.label+"]"]),a["report_fields[$"+
A.id+"]"]&&(h=a["report_fields[$"+A.id+"]"]),h&&("string"===typeof h?"D"===A.type&&"#TODAY#"===h&&(h=new Date,h=h.getUTCFullYear()+"-"+c(h.getUTCMonth()+1)+"-"+c(h.getUTCDate())):(h=d(h.pkey,e.okeys[0]),a.report.roFields[A.id]=a.formatFieldEntry(h),a.report.overrides[A.id]=""),f[A.id]=h)}function n(){if(b.report_url_redirect){var d=b,g;g=b.report_url_redirect;if(-1!=g.indexOf("[LABEL_INDEXED_FIELDS]")){var e="",f;for(f in a.report.fields)if(a.report.fields.hasOwnProperty(f)){var h;b:{h=a.report.activity;
for(var n=0;n<h.tabs.length;n++)for(var p=0;p<h.tabs[n].fields.length;p++)if(h.tabs[n].fields[p].id==f){h=h.tabs[n].fields[p].label;break b}h=void 0}e+="fields["+h+"]="+a.report.fields[f]+"&"}e=e.slice(0,e.length-1);g=g.replace("[LABEL_INDEXED_FIELDS]",e)}else if(-1!=g.indexOf("[KEY_INDEXED_FIELDS]")){e="";for(f in a.report.fields)a.report.fields.hasOwnProperty(f)&&(e+="fields["+f+"]="+a.report.fields[f]+"&");e=e.slice(0,e.length-1);g=g.replace("[KEY_INDEXED_FIELDS]",e)}else g=void 0;d.report_url_redirect=
g;document.location=b.report_url_redirect}else console.log(b),c.path("map/"+b.site.id)}b.site=b.site||f.get("sites")[d.site];a.step="assets";a.fromConsult=!1;e.buildAllTemplates(a.site.activities);a.report={assets:[],fields:{},roFields:{},overrides:{},ged:[],activity:null,uuid:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})};d.assets&&!g.isLatLngString(d.assets)?(a.fromConsult=!0,a.step="form",f.findAssetsByGuids(b.site,
d.assets.split(","),function(b){a.report.assets=b;p();a.$$phase||a.$apply()})):d.assets&&g.isLatLngString(d.assets)&&(a.fromConsult=!0,a.report.latlng=d.assets,a.step="form");a.loadAssets=function(){f.findAssetsByOkey(b.site,a.report.activity.okeys[0],function(b){a.assets=b;a.$$phase||a.$apply()})};if(d.activity){a.reportTemplate="report-"+d.activity+".html";for(m=0;m<b.site.activities.length;m++)if(b.site.activities[m].id==d.activity){a.report.activity=b.site.activities[m];d=a.report.activity;m=
0;for(e=d.tabs.length;m<e;m++){tab=d.tabs[m];g=0;for(var r=tab.fields.length;g<r;g++)tab.fields[g].isconsequence=!1===tab.fields[g].visible}break}a.fromConsult||a.loadAssets()}a.numberPattern=/^(\d+([.]\d*)?|[.]\d+)$/;a.formatFieldEntry=function(a){if("string"===typeof a)return a;var b=[],c;for(c in a)a[c]&&b.push(a[c]);return b.join(", ")};a.applyConsequences=function(b){var c=h(b),d,g,e,f,n;if(!c.actions)return!1;g=0;for(e=c.actions.length;g<e;g++)if(f=c.actions[g],d=h(f.target))switch(n=a.report.fields[b]==
f.condition,f.type){case "show":d.visible=n;break;case "require":d.required=n}};a.toForm=function(){a.step="form";p()};a.cancel=function(){c.path("map/"+b.site.id)};a.sendReport=function(c){var d=angular.copy(a.report);for(c=0;c<d.assets.length;c++)d.assets[c]=d.assets[c].id;for(c=0;c<d.ged.length;c++)d.ged[c]={content:getBase64Image(d.ged[c].content)};for(c in d.overrides)d.overrides[c]&&(d.fields[c]=d.overrides[c]);delete d.overrides;delete d.roFields;d.activity=d.activity.id;d.timestamp=(new Date).getTime();
d.mission=1*b.report_mission||d.mission;l.post(f.get("url")+"gi.maintenance.mobility.report.json",d).error(function(){var a=f.get("reports")||[];a.push(d);b.$broadcast("REPORT_LOCAL_NUMBER_CHANGE");f.set("reports",a);n()}).then(function(){n()})};a.toggleCollapse=function(a){a.preventDefault()};getBase64Image=function(a){var b=document.createElement("img");b.src=a;a=document.createElement("canvas");a.width=b.width;a.height=b.height;a.getContext("2d").drawImage(b,0,0);return a.toDataURL("image/png")}}]);
angular.module("smartgeomobile").controller("searchController",["$scope","$routeParams","$window","$rootScope","Smartgeo","SQLite",function(a,d,m,b,f,c){a.mlPushMenu=new mlPushMenu(document.getElementById("mp-menu"),document.getElementById("trigger"),{type:"cover"});a.searchIsPerforming=!1;a.select2Options={allowClear:!0};a.selectedCriteriaValues={};a.criteria={};for(var l in b.site.metamodel)for(a.criteria[l]=[],a.criteria[l]._byKey=[],d=0;d<b.site.metamodel[l].tabs.length;d++)for(m=0;m<b.site.metamodel[l].tabs[d].fields.length;m++)a.criteria[l].push(b.site.metamodel[l].tabs[d].fields[m]),
a.criteria[l]._byKey[b.site.metamodel[l].tabs[d].fields[m].key]=b.site.metamodel[l].tabs[d].fields[m];a.search=function(c){c.preventDefault();a.searchMessage="Recherche en cours";a.searchIsPerforming=!0;f.findAssetsByLabel(b.site,angular.copy(a.searchTerms),function(c){a.searchIsPerforming=!1;if(c.length){a.searchMessage="";for(var d=[],e,f,l=0;l<c.length;l++)f=c[l],e=JSON.parse(f.asset),e.label=f.label,e.geometry=JSON.parse(f.geometry),d.push(e);b.$broadcast("UPDATE_CONSULTATION_ASSETS_LIST",d);
a.mlPushMenu._resetMenu()}else a.searchMessage="Aucun r\u00e9sultat",a.$apply()})};a.resetCriteria=function(){a.selectedFamily=null;a.selectedCriteria=null};a.selectedCriteriaChangeHandler=function(){for(var b={},c=0;c<a.selectedCriteria.length;c++)a.selectedCriteriaValues[a.selectedCriteria[c].key]&&(b[a.selectedCriteria[c].key]=a.selectedCriteriaValues[a.selectedCriteria[c].key]);a.selectedCriteriaValues=b};a.advancedSearch=function(c){c.preventDefault();c={criteria:a.selectedCriteriaValues,okey:a.selectedFamily.okey};
a.searchIsPerforming=!0;f.findAssetsByCriteria(b.site,c,function(c){a.searchIsPerforming=!1;if(c.length){a.advancedSearchMessage="";for(var d=[],e,f,l=0;l<c.length;l++)f=c[l],e=JSON.parse(f.asset),e.label=f.label,e.geometry=JSON.parse(f.geometry),d.push(e);b.$broadcast("UPDATE_CONSULTATION_ASSETS_LIST",d);a.mlPushMenu._resetMenu()}else a.advancedSearchMessage="Aucun r\u00e9sultat",a.$apply()})}}]);
angular.module("smartgeomobile").controller("siteInstallController",["$scope","$routeParams","$http","Smartgeo","SQLite","$location","G3ME","Installer",function(a,d,m,b,f,c,l,e){function g(b){var c=[],d=b.number,e;a.totalProgress=1*d.total;for(e in d)"number"!==e&&(b=h[e]={progress:0,target:1*d[e],okey:e},c.push(b));e=2*Math.PI/3;b=2*Math.PI/c.length;for(var g,f,l=0,m=c.length;l<m;++l)d=Math.round(127*Math.sin(b*l+2+e)+128),g=Math.round(127*Math.sin(b*l+0+e)+128),f=Math.round(127*Math.sin(b*l+4+e)+
128),c[l].color="rgb("+[d,g,f]+")";a.steps=c}a.steps=[{color:"#fd9122",progress:0,target:100}];a.totalProgress=100;a.Math=Math;a.sites=b.get("sites")||{};a.sites[d.site]&&!0===a.sites[d.site].installed&&c.path("/map/"+d.site);var h={};b=b.getServiceUrl("gi.maintenance.mobility.site.json");m.get(b).success(function(b){a.steps[0].progress=50;angular.extend(a.sites,b);for(var f=0;f<b.length;f++)b[f].id===d.site&&(a.site=b[f]);e.getInstallJSON(a.site,function(b){a.steps[0].progress=100;b=e.formatSiteMetadata(b);
g(b);angular.extend(a.site,b);e.createZones(a.site,function(){e.install(a.site,a.site.stats,function(){a.site.installed=!0;e.saveSite(a.site);c.path("/map/"+d.site);a.$$phase||a.$apply()})})})});a.$on("_INSTALLER_I_AM_CURRENTLY_DOING_THIS_",function(b,c){a.currentInstalledOkey=c.okey;h[c.okey].progress=1*c.progress;a.$$phase||a.$apply()})}]);
angular.module("smartgeomobile").controller("siteListController",["$scope","$http","$location","Smartgeo",function(a,d,m,b){function f(){var c=b.getServiceUrl("gi.maintenance.mobility.site.json");d.get(c).success(function(c){for(var d=b.get("sites")||{},e,f={},m=0,q=c.length;m<q;m++)e=c[m],f[e.id]=e;angular.extend(f,{},d);a.sites=[];for(var s in f)a.sites.push(f[s]);l();a.ready=!0})}function c(){var c=b.get("sites")||{};a.sites=[];for(var d in c)a.sites.push(c[d]);l();a.ready=!0;console.log(a.sites)}
function l(){if(1<a.sites.length)a.ready=!0;else{var b=a.sites[0];b&&b.installed?m.path("/map/"+b.id):m.path("/sites/install/"+b.id)}}a.ready=!1;a.version=b._SMARTGEO_MOBILE_VERSION;a.isInstalled=function(a){return!!a.installed};a.isUnInstalled=function(a){return!a.installed};a.online=b.get("online");!0===a.online?f():c()}]);
angular.module("smartgeomobile").controller("siteUninstallController",["$scope","$rootScope","$routeParams","$http","Smartgeo","SQLite","$location","G3ME","Installer",function(a,d,m,b,f,c,l,e,g){var h=f.get("sites");d.site=d.site||h[m.site];g.uninstallSite(d.site,function(){delete h[d.site.id];f.set("sites",h);l.path("#");a.$$phase||a.$apply()})}]);
angular.module("smartgeomobile").controller("siteUpdateController",["$scope","$rootScope","$routeParams","$http","Smartgeo","SQLite","$location","G3ME","Installer",function(a,d,m,b,f,c,l,e,g){function h(b){var c=[],d=b.number,e;a.totalProgress=1*d.total;for(e in d)"number"!==e&&(b=p[e]={progress:0,target:1*d[e],okey:e},c.push(b));e=2*Math.PI/3;b=2*Math.PI/c.length;for(var f,g,h=0,l=c.length;h<l;++h)d=Math.round(127*Math.sin(b*h+2+e)+128),f=Math.round(127*Math.sin(b*h+0+e)+128),g=Math.round(127*Math.sin(b*
h+4+e)+128),c[h].color="rgb("+[d,f,g]+")";a.steps=c}a.steps=[{color:"#fd9122",progress:0,target:100}];a.totalProgress=100;a.Math=Math;var p={};a.site=f.get("sites")[m.site];c=f.getServiceUrl("gi.maintenance.mobility.site.json");b.get(c).success(function(b){a.steps[0].progress=50;a.sites=f.get("sites")||{};angular.extend(a.sites,b);for(var c=0;c<b.length;c++)b[c].id===a.siteId&&(a.site=b[c]);g.getUpdateJSON(a.site,function(b){b=g.formatSiteMetadata(b,!0);a.steps[0].progress=100;h(b);a.site.oldTimestamp=
a.site.timestamp;angular.extend(a.site,b);g.update(a.site,a.site.stats,function(){g.saveSite(a.site);d.site=a.site;l.path("/map/"+m.site);a.$$phase||a.$apply()})})});a.$on("_INSTALLER_I_AM_CURRENTLY_DOING_THIS_",function(b,c){a.currentInstalledOkey=c.okey;p[c.okey].progress=1*c.progress;a.$$phase||a.$apply()})}]);
angular.module("smartgeomobile").controller("synchronizationMenuController",["$scope","$rootScope","$http","$location","Smartgeo","$window",function(a,d,m,b,f,c){d.site.activities._byId=[];for(i=0;i<d.site.activities.length;i++)d.site.activities._byId[d.site.activities[i].id]=d.site.activities[i];a.mlPushMenu=new mlPushMenu(document.getElementById("mp-menu"),document.getElementById("trigger"),{type:"cover"});a.reports=f.get("reports")||[];d.$on("DEVICE_IS_ONLINE",function(){a.syncAll()});a.syncAll=
function(){for(var b=0;b<a.reports.length;b++)a.sync(b)};a.sync=function(b){m.post(f.get("url")+"gi.maintenance.mobility.report.json",a.reports[b]).success(function(){a.reports=a.reports.slice(0,b).concat(a.reports.slice(b+1,a.reports.length));f.set("reports",a.reports);d.$broadcast("REPORT_LOCAL_NUMBER_CHANGE")}).error(function(a){a.error&&c.alert("CR Non synchronis\u00e9 : "+a.error.text)})};a.__delete=function(b){a.reports=a.reports.slice(0,b).concat(a.reports.slice(b+1,a.reports.length));f.set("reports",
a.reports);d.$broadcast("REPORT_LOCAL_NUMBER_CHANGE")}}]);
